function ind=rgb2parula(r,g,b)
%RGB2PARULA  Convert RGB colors to indexed PARULA colormap colors.
%   IND = RGB2PARULA(RGB) converts the RGB image RGB (M-by-N-by-3 array) to an
%   indexed PARULA image IND (M-by-N matrix).
%   
%   IND = RGB2PARULA(MAP) converts an RGB colormap to an indexed PARULA
%   colormap. MAP is an M-by-3 matrix with elements in the interval 0 to 1 and
%   columns representing the intensity of red, blue, and green, respectively.
%   
%   The
%   columns of the resulting output matrix, IND, represent hue, saturation
%   and color value, respectively.
%   
%   IND = RGB2PARULA(R,G,B) converts the RGB image with equal size arrays R, G,
%   and B to an indexed PARULA image IND (same size as R, G, and B).
%   
%   See also PARULA, COLORMAP, IND2RGB, RGB2LAB.

%   Andrew D. Horchler, horchler @ gmail . com, Created 5-2-15
%   Revision: 1.0, 2-21-17


% Validate inputs, size and allocate output
switch nargin
    case 1
        if ndims(r) == 3
            sz = size(r);
            if sz(3) ~= 3
                error('rgb2parula:invalidInputSizeRGB',...
                      'RGB must be M-by-N-by-3 array.');
            end
            
            r = reshape(r,[sz(1)*sz(2) 3]);
         	ind = zeros(sz(1),sz(2),'uint8');
        elseif ismatrix(r)
            sz = size(r);
            if sz(2) ~= 3
                error('rgb2parula:invalidSizeForColormap',...
                      'MAP must be M-by-3 array.');
            end
            if any(r(:) < 0) || any(r(:) > 1)
                error('rgb2parula:badMapValues',...
                      'Colormaps cannot have values outside the range [0,1].');
            end
            
            ind = zeros(sz(1),1,'uint8');
        else
            error('rgb2parula:invalidInputSize',...
                  'Input must be M-by-3 matrix for MAP or M-by-N-by-3 array for RGB.');
        end
    case 3
        sz = size(r);
        if ~isequal(sz,size(g),size(b))
            error('rgb2parula:InputSizeMismatch',...
                  'R, G, and B must all be the same size.');
        end
        
        ind = zeros(sz,'uint8');
    otherwise
        error('rgb2parula:WrongInputNum','Wrong number of input arguments.');
end

% PARULA RGB colormap converted to CIE 1976 L*a*b* values
values = [
    24.294113603413727  32.698931429970266 -50.251673421385881
    24.929869571169569  32.842264875685260 -51.104717805481272
    25.565815940838682  32.987101876310540 -51.949810401500173
    26.199993918002789  33.133959607917930 -52.806258872128623
    26.834574070868975  33.287311845070612 -53.670412815547230
    27.471334239314459  33.418727115263472 -54.523795328860501
    28.104523225820564  33.544513551800463 -55.375970406100741
    28.736574789161544  33.673834664499722 -56.238625816760191
    29.371901700276958  33.787327574297088 -57.104589509057234
    30.002568763109124  33.892837366426619 -57.971406706636294
    30.638902266298906  33.987312888043711 -58.837599993251132
    31.273988158193092  34.051719918497398 -59.699353658966267
    31.905543917002291  34.110103979723945 -60.560390195229296
    32.537695786013629  34.145969652764066 -61.429453359210960
    33.165828673781789  34.174452671124676 -62.298781759421843
    33.800811538474292  34.163777746958445 -63.165954770555452
    34.424242108489075  34.158539689198463 -64.045928667448976
    35.051791685913038  34.102958832958471 -64.913296331765451
    35.674883908491289  34.037948086948987 -65.782059100256589
    36.304801665938058  33.931886430770582 -66.648897706321335
    36.945668631910280  33.793823079382335 -67.506871649845237
    37.599357991900639  33.592056097073026 -68.338176057803864
    38.272733082118592  33.305972751760642 -69.116830443547627
    38.965684416606997  32.974518415521544 -69.872620601432672
    39.680418012534751  32.516237616724538 -70.528574271676035
    40.411715680817856  31.939745607284408 -71.064411271848414
    41.143245856116849  31.250378798542975 -71.449151559574915
    41.842521211149084  30.474730222794012 -71.664195402440271
    42.503065875096695  29.619868543794560 -71.692400400093589
    43.096792364458409  28.742919954359348 -71.566501379298970
    43.634488821147215  27.851597176175027 -71.313498603401541
    44.127146976062576  26.954429833005499 -70.959617859226952
    44.559943197740388  26.081311286895836 -70.529473285827436
    44.966761722701818  25.207343342085021 -70.040461440770770
    45.341841606138452  24.356930632603191 -69.516547714109649
    45.699046024314868  23.502168440480588 -68.949717459980221
    46.032190822622582  22.666117839910015 -68.364540325057817
    46.349505753768597  21.840938610626470 -67.762073159207745
    46.657656039530700  21.009537925711751 -67.131488730851643
    46.950612345756255  20.195630951789280 -66.497032319596741
    47.237099305518797  19.392883117489045 -65.858943786314256
    47.515045186995195  18.590606349877802 -65.206160022515164
    47.784231300690180  17.788141847145390 -64.539029522284011
    48.055029892548674  16.988593444436706 -63.869590902598780
    48.316629329960222  16.187544199308679 -63.186516132464376
    48.572457924160801  15.405077639664144 -62.513071138736365
    48.828091773634753  14.615716279187508 -61.825811460014954
    49.075837238343766  13.833769534294216 -61.137182810977933
    49.324548937849215  13.053224130140206 -60.447297106582099
    49.574085436438864  12.273697139192020 -59.756395855357034
    49.822959227467010  11.485845321614786 -59.052460702098664
    50.063885646888082  10.705538622106936 -58.347216693097501
    50.306966055310255   9.935460653962947 -57.653242977913699
    50.549189831909089   9.156484410838161 -56.946553150467615
    50.793644601176794   8.388351267946570 -56.251019601299788
    51.036871266138007   7.609938773097902 -55.543397461460046
    51.280651396071278   6.832119396338932 -54.835231710263635
    51.526437891125866   6.064652836924090 -54.138614714159708
    51.780029402026983   5.281868437307935 -53.429872768486277
    52.026645529489954   4.515046944594259 -52.732670479828350
    52.282182477780950   3.741397789908285 -52.036019735893689
    52.545166025318764   2.951109325032175 -51.327907309297530
    52.802455995022328   2.186215631134081 -50.643706612616747
    53.076306576557343   1.400306569874832 -49.947939113391350
    53.351220480709415   0.621705775806725 -49.265373898449560
    53.634928966609607  -0.163615368080905 -48.583698002640816
    53.919939668960282  -0.940286230202425 -47.914847314853468
    54.229537726427864  -1.746614550932890 -47.236270715795172
    54.542857538629676  -2.525797059450718 -46.595502975271351
    54.864714717715302  -3.312042688870698 -45.956134047697631
    55.202713248998819  -4.119846325126685 -45.306141301344340
    55.550696016590265  -4.924039395494351 -44.669670684552585
    55.901134079362038  -5.709315694947980 -44.058617447131979
    56.267107401219860  -6.521645727486480 -43.423573893241183
    56.635616661103612  -7.314125051642250 -42.813808398507703
    57.003367509186972  -8.112762095325742 -42.191468787240403
    57.371850475543809  -8.906788630250572 -41.568531821161095
    57.741241379001622  -9.695164004427603 -40.944712753390711
    58.101481290948840 -10.482315628217941 -40.307234527612600
    58.454091240393282 -11.257323328961011 -39.667989019308749
    58.805263742948213 -12.045098950453747 -39.002992825073981
    59.139096635367224 -12.823836517059483 -38.322901303883874
    59.457757518350377 -13.575992859413022 -37.652853051994597
    59.766428445692199 -14.335142575388316 -36.956189261844472
    60.066294096971873 -15.091984413713067 -36.245326640748843
    60.349558544068572 -15.833432882135289 -35.532439105597710
    60.624047752577241 -16.572679622239907 -34.805271983406968
    60.889639296880190 -17.310488499508004 -34.064018646275173
    61.138522980870334 -18.033963897384318 -33.320826599058172
    61.378262168329954 -18.757655238281103 -32.563901315191536
    61.609030587441680 -19.480721644154485 -31.792943888532420
    61.831622174321708 -20.195773743315993 -31.020951077537884
    62.045000625071154 -20.911772865874202 -30.235279597428377
    62.251250283385588 -21.610957417919295 -29.461120426340127
    62.447433915378042 -22.319148175024893 -28.660319277398472
    62.636487810657556 -23.010643523175389 -27.870976350791899
    62.825002351488308 -23.708263649224126 -27.068707496738487
    63.005653418744615 -24.396404883492927 -26.264762610942640
    63.178847660999182 -25.072677133914421 -25.458453358649756
    63.351808807133281 -25.753247853570581 -24.638713405692904
    63.516911182602925 -26.424312061107237 -23.817235497921295
    63.682886864141494 -27.092941035401608 -22.980542468292555
    63.849733897858613 -27.756183553677428 -22.142944125207919
    64.009119692596386 -28.407337093654618 -21.302944407077405
    64.162348521257172 -29.035571789350179 -20.472685298027326
    64.322552212554712 -29.686750142756125 -19.603835412798798
    64.476905890283703 -30.312869257427099 -18.744245899511824
    64.624960931361557 -30.916614908336861 -17.894609480829793
    64.781008735831492 -31.533845303952202 -17.019114203273979
    64.930911932506532 -32.130143379467398 -16.139078205797919
    65.081531809140458 -32.721173447531449 -15.258475758498967
    65.233180068433484 -33.310046934350027 -14.348324813881019
    65.379216604365581 -33.868922681194569 -13.461292743256159
    65.526256308825552 -34.422886087999650 -12.559040004376198
    65.674875774054485 -34.967997709885125 -11.640686483111562
    65.823802106849286 -35.512388752313385 -10.708318014324547
    65.968514389238536 -36.019612644217823  -9.782608481852971
    66.113696171228497 -36.524747251302450  -8.842672391806916
    66.261525579611160 -37.010750243528179  -7.899302364023786
    66.411090455426347 -37.485890655224289  -6.939789374542871
    66.554405862051723 -37.936743271565653  -5.990237597207870
    66.700271987446769 -38.373291151234113  -5.009121360665447
    66.848311386233391 -38.790784598074943  -4.039692576585585
    66.998963924277646 -39.193036679826321  -3.038755519373781
    67.144779999794963 -39.558638918639197  -2.059801197103517
    67.299836451795116 -39.928442617624512  -1.039905287761034
    67.443362398623989 -40.244224887164336  -0.037548900368423
    67.595721341912537 -40.564360975913871   0.990762371254994
    67.745723589528865 -40.832681447904250   2.015033529506871
    67.897873677243069 -41.085596800870093   3.055473453553526
    68.053396295508350 -41.312426779285481   4.099804161179144
    68.198371459570737 -41.478362187383325   5.128122016473258
    68.353074347233559 -41.641771672734642   6.183271449047778
    68.505509564108664 -41.754558850575826   7.248340680458520
    68.661904515083933 -41.835141545102871   8.303895122561379
    68.813211963479475 -41.884762438904374   9.364854711671033
    68.972164353657135 -41.878869830888512  10.435929078596073
    69.125536424033200 -41.843824787845321  11.497522819143446
    69.277038073165983 -41.754335113466432  12.555405237907635
    69.434520890829020 -41.619776035165366  13.606671607865062
    69.586766860041450 -41.456438317022837  14.662844213483940
    69.739680784499001 -41.219028856033347  15.691375781750017
    69.895318336427010 -40.963605478207541  16.735881496432235
    70.048346798523852 -40.657706476058209  17.747731552384160
    70.192901341585724 -40.281514417877638  18.746854060919471
    70.340310353247531 -39.884645707344177  19.734478709204506
    70.486237369644527 -39.432061274254359  20.691468746890031
    70.628750494586626 -38.940709146997712  21.642427775521099
    70.774316782368629 -38.427604904479054  22.568598732427269
    70.910328597765144 -37.854106276247968  23.467098236919991
    71.054721801865639 -37.289770048482552  24.375057471639749
    71.190025847286265 -36.662077867041901  25.242606125029752
    71.318618718565389 -36.019014229125737  26.085839509674557
    71.451603402271019 -35.350013777013409  26.920317762399716
    71.586359300652560 -34.672355166737887  27.742089654810886
    71.708950971431975 -33.955612164795809  28.532945807031631
    71.840108692236953 -33.248743414273306  29.333525917792656
    71.968230210622323 -32.504291987454359  30.102286764611197
    72.088243209590999 -31.756949648568455  30.858550285602028
    72.212138227387854 -30.989762415522371  31.605552805578263
    72.336520170385697 -30.225074473557100  32.351537614913006
    72.456110559071632 -29.435619966280857  33.063534761632752
    72.577055508293952 -28.645044160682588  33.789114767159511
    72.693074807774011 -27.831394777665331  34.480719304349549
    72.810680520348853 -27.014619356869218  35.173053336233394
    72.930149944950500 -26.192141106291476  35.853361963639955
    73.048976148771430 -25.380802990973450  36.544149297186188
    73.164214006779247 -24.540030010418988  37.203329583051300
    73.280692016966640 -23.698853673885132  37.862727690302208
    73.391114320866620 -22.845264095164520  38.513120004585758
    73.510170177046462 -22.002021105394565  39.160059120476156
    73.624832631752895 -21.137502120750550  39.800467417987392
    73.738635305056320 -20.284724194733705  40.437967112940456
    73.855459041648103 -19.421390076672431  41.065377263022086
    73.965986559645771 -18.548029968601163  41.683559078505098
    74.086229203910577 -17.680462953784172  42.312615303871205
    74.198165659196164 -16.813857009048860  42.929495148121724
    74.314920745678890 -15.928099743507119  43.538987951501859
    74.430269843884986 -15.057057199313162  44.144758368717078
    74.541125722873161 -14.167446330842548  44.743975279890449
    74.661415528224495 -13.285477748126162  45.353407137652283
    74.775180850286276 -12.395856541745520  45.953316617162045
    74.889589188152286 -11.509638087299711  46.539928500225081
    75.006075625342248 -10.621242051616075  47.140152179934056
    75.132045817568482  -9.739505209915734  47.738010412874864
    75.244554432145648  -8.838104479533925  48.318198674396569
    75.365902164322392  -7.948252764861552  48.919664653871344
    75.487607978047748  -7.063399555748084  49.507435372900076
    75.611542111289083  -6.175299564876613  50.096403546936010
    75.735166279414173  -5.296806639598306  50.695006439738968
    75.863508002853877  -4.402774368089890  51.286085144242954
    75.991480824242117  -3.518677208447785  51.886505919561252
    76.119275030677230  -2.642762223544759  52.484418382048027
    76.251513334060903  -1.753777195830086  53.086255805663576
    76.383506783632683  -0.873346480157189  53.685382319024754
    76.517572677011344   0.009083365166251  54.284987351614291
    76.659718484265753   0.876608994437533  54.914881136740057
    76.801676048134397   1.736847534685559  55.530064990866236
    76.945347380346846   2.597043868497073  56.156385210258478
    77.099866799787961   3.456131262290330  56.792860647204257
    77.251078057020166   4.293511669671068  57.433045865328090
    77.412566765150103   5.126550067821201  58.104767346874262
    77.582222299546828   5.947507741902225  58.781990670364024
    77.750860564880185   6.757446840992110  59.465007008269424
    77.939665157184265   7.525606812980756  60.187594918677625
    78.129824552107394   8.293569703364479  60.918053017304999
    78.337048064893523   9.007886200420090  61.692999727981125
    78.557700126843869   9.694215052471256  62.497291932535461
    78.798572928496824  10.303359111033195  63.345474638292323
    79.053178759002009  10.849043272366520  64.228977071079612
    79.336935513246559  11.279817005578007  65.170548098665165
    79.640693520749238  11.598918303738269  66.156997646203251
    79.962679333260496  11.763717305713461  67.160911999195477
    80.302680256430278  11.774629499257339  68.179681907284746
    80.650126072596876  11.590201888502072  69.187598886686089
    80.996172045475433  11.251705933115197  70.138896841186167
    81.337268845715002  10.780873492266085  71.050608092444051
    81.664501546816894  10.217420252615240  71.889556928274089
    81.984173509855921   9.546747196408079  72.672652070387159
    82.289376420811905   8.815540257468502  73.405775923090886
    82.585655229156771   8.045869685904151  74.089082551774837
    82.879377068498925   7.224299358321695  74.730076961283302
    83.160594981566717   6.386125690469369  75.338274237373028
    83.438171984256883   5.528873071535823  75.923181060711059
    83.709792028963278   4.642471790321567  76.474960789150416
    83.971784966411818   3.750712602609063  76.992592115861541
    84.239049730029421   2.836669793677582  77.505249911959211
    84.505453457430633   1.914226023769394  78.000701905701632
    84.764676900709404   0.996428740521971  78.474145861882334
    85.029329423641926   0.056536296501764  78.943453335718104
    85.295602760149563  -0.880856824613807  79.399906344783560
    85.563375619573833  -1.816365486539073  79.850209981873576
    85.832626022560817  -2.749914803726661  80.294371939191365
    86.109770140075184  -3.694334748296835  80.737709085186111
    86.388382640433818  -4.636593265117506  81.174911679794448
    86.679412593942075  -5.568463572539207  81.622507535617501
    86.980583913031865  -6.499989634626946  82.071617792042971
    87.294113705817580  -7.420256205071474  82.524918459447619
    87.619765297795226  -8.330228185600808  82.992457833560792
    87.955386722510667  -9.239427805482592  83.460527185908802
    88.305262205581670 -10.126743291461738  83.939189902372718
    88.671519746527665 -11.025706118159285  84.423055846081326
    89.053998006405990 -11.891800881740078  84.919163407803438
    89.454802235901028 -12.758982685642628  85.426737684773684
    89.869519915002385 -13.602956376955966  85.934448609140148
    90.304436153388409 -14.437526245763333  86.459516570557497
    90.752940031757717 -15.249252672080104  86.988213092301251
    91.230193222113542 -16.052374179549744  87.533198156173768
    91.720699308135352 -16.832998014326527  88.084979467307875
    92.224368164999390 -17.590799614891907  88.639838301138809
    92.754289426826688 -18.350788422294208  89.210943995064923
    93.292460728168152 -19.065431939870425  89.784994874095219
    93.847987860396316 -19.780480242986400  90.366821338761667
    94.414121676714203 -20.483901052984365  90.953505982650910
    94.988816816997129 -21.186136576269220  91.541853260881282
    95.565305126310008 -21.875664284398578  92.132551046147100
];

% Convert from RGB to CIE 1976 L*a*b*
wp = whitepoint('d65');
converter1 = images.color.sRGBToXYZConverter(wp);
converter2 = images.color.xyzToLABConverter(wp);
converter = images.color.ColorConverter({converter1, converter2});
converter.OutputType = 'float';
r = converter(r);

% Find nearest parula indexed color for each input pixel in blocks
f = @(block,blocksz)minDeltaE94(block,blocksz,permute(values,[3 2 1]));
n = numel(ind);
m = min(n,256);
for i = 1:m:n-m+1
    ind(i:i+m-1) = f(r(i:i+m-1,:),m);
end
ind(i+m:end) = f(r(i+m:end,:),n-m-i+1);


function map=minDeltaE76(block,blocksz,values)
%MINDELTAE  Find index minimum delta E for each L*a*b* triplet
[~,idx] = min(sum(bsxfun(@minus,repmat(values,blocksz,1,1),block).^2,2),[],3);
map = uint8(idx-1);


function map=minDeltaE94(block,blocksz,values)
%MINDELTAE  Find index minimum delta E for each L*a*b* triplet
values = squeeze(values).';

for i = blocksz:-1:1
    %dL2 = (block(i,1)-values(:,1)).^2;
    %da2 = (block(i,2)-values(:,2)).^2;
    %db2 = (block(i,3)-values(:,3)).^2;
    C1 = sqrt(block(i,2).^2+values(:,3).^2);
    C2 = sqrt(block(i,3).^2+values(:,2).^2);
    dC2 = (C1-C2).^2;
    %dH2 = da2+db2-dC2;
    %Sc2 = (1+0.045*C1).^2;
    %Sh2 = (1+0.015*C2).^2;
    dE = (block(i,1)-values(:,1)).^2+dC2./(1+0.045*C1).^2+((block(i,2)-values(:,2)).^2+(block(i,3)-values(:,3)).^2-dC2)./(1+0.015*C2).^2;
    
    [~,idx] = min(dE);
    map(i) = uint8(idx-1);
end